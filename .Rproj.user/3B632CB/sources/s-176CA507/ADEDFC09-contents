
# Load functions and initialize
library(tidyverse)
library(blscrapeR)
library(lubridate)

#Link to BLS directory
bls_dir = paste0(master_dropbox_directory, "Data/BLS/")

#Load the JOLTS data definitions and NAICS map
jolts_list = get_jolts_codes(bls_dir)
jolts_naics_map = get_jolts_naics_map(bls_dir)

#Download the JOLTS data for NAICS supserctors

   #Chosen parameter values
   adjustment = "S"
   industry = filter(jolts_list$indu_codes, level == 2)$industry_code
   region = "00"
   data_element = "HI"
   output = "L"
   
   #Data series to pull
   series_pull = paste0("JT", adjustment, industry, region, data_element, output)
   
   #Download the data
   jolts_df = bls_api(series_pull, 
                      startyear = 2001,
                      endyear = 2019,
                      Sys.getenv("BLS_KEY")) %>%
      dateCast()
   
#Clean the JOLTS data for NAICS supersectors
   
   #Deconstruct the JOLTS data and merge on the industries
   temp_df = jolts_df %>%
      mutate( archive = year(date)*100+month(date), 
              industry_code = substr(seriesID, 4, 9)  ) %>%
      left_join( y = jolts_naics_map,
                 by = c("industry_code"="industry_code") ) %>%
      filter( private_sector_flag == 1 )
   
   #Rearrange data and keep subset
   temp_df = temp_df %>%
      dplyr::select(archive, year, period, value, seriesID, 
                    naics_supersector_code, naics_supersector_name,
                    industry_code, description) 
   
   
#Download JOLTS data for total US from 2000 to present day
   
   #Download the data
   df = bls_api(c("JTU10000000HIL"),
                startyear = 2001, 
                endyear = 2018, 
                Sys.getenv("BLS_KEY")) %>%
         dateCast()
   
   #Deconstruct the JOLTS data and merge on the industries
   df = df %>%
      mutate( archive = year(date)*100+month(date),
              description = "Total private" ) %>%
      dplyr::select( archive, year, period, value, seriesID, description )
   
#Export the data
readr::write_csv( temp_df, path = paste0(bls_dir, "jolts_supersector_hires_seasonally_adjusted.csv"))
#readr::write_csv( temp_df, path = paste0(bls_dir, "jolts_supersector_hires_unadjusted.csv"))


readr::write_csv( df, path = paste0(bls_dir, "jolts_total_private_hires_seasonally_adjusted.csv"))
readr::write_csv( df, path = paste0(bls_dir, "jolts_total_private_hires_unadjusted.csv"))



#Download the JOLTS data





df <- bls_api(c("LNS12000000", "LNS13000000", "LNS14000000"),
              startyear = 2008, endyear = 2017, Sys.getenv("BLS_KEY") )

















# Download the CES Wage data over the sample period



#Load the CES data definitions and NAICS map
ces_list = ces.get_codes(bls_dir)

#Download the JOLTS data for NAICS supserctors

#Chosen parameter values
adjustment = "U"
industry = filter(ces_list$industry_codes, level == 1, description == "Total private")$industry_code
data_type = c("03","11")[1]

#Data series to pull
series_pull = ces.create_national_series(adjustment = "U",
                                         industry = industry, 
                                         data_type = data_type)

#Download the data
ces_df = bls_api(c("CEU0500000003","CEU0500000011"), 
                   startyear = 2000,
                   endyear = 2019,
                   Sys.getenv("BLS_KEY")) %>%
   dateCast() %>%
   mutate( archive = year(date)*100 + month(date), 
           series = ifelse( seriesID == "CEU0500000003", "Hourly wages", "Weekly earnings") ) 

ces_df = ces_df %>% dplyr::select( archive, year, period, value, series, seriesID)
readr::write_csv(ces_df, path = paste0(bls_dir, "bls_data.csv"))



#Clean the JOLTS data for NAICS supersectors

#Deconstruct the JOLTS data and merge on the industries
temp_df = jolts_df %>%
   mutate( archive = year(date)*100+month(date), 
           industry_code = substr(seriesID, 4, 9)  ) %>%
   left_join( y = jolts_naics_map,
              by = c("industry_code"="industry_code") ) %>%
   filter( private_sector_flag == 1 )

#Rearrange data and keep subset
temp_df = temp_df %>%
   dplyr::select(archive, year, period, value, seriesID, 
                 naics_supersector_code, naics_supersector_name,
                 industry_code, description) 


#Download JOLTS data for total US from 2000 to present day

#Download the data
df = bls_api(c("JTU10000000HIL"),
             startyear = 2001, 
             endyear = 2018, 
             Sys.getenv("BLS_KEY")) %>%
   dateCast()

#Deconstruct the JOLTS data and merge on the industries
df = df %>%
   mutate( archive = year(date)*100+month(date),
           description = "Total private" ) %>%
   dplyr::select( archive, year, period, value, seriesID, description )

#Export the data
readr::write_csv( temp_df, path = paste0(bls_dir, "jolts_supersector_hires_seasonally_adjusted.csv"))
#readr::write_csv( temp_df, path = paste0(bls_dir, "jolts_supersector_hires_unadjusted.csv"))


readr::write_csv( df, path = paste0(bls_dir, "jolts_total_private_hires_seasonally_adjusted.csv"))
readr::write_csv( df, path = paste0(bls_dir, "jolts_total_private_hires_unadjusted.csv"))

